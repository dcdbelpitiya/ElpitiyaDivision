<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elpitiya Division - Vehicle Management</title>
    <link rel="icon" href="logo.jpg" type="image/jpg">

    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/min.css">

    <!-- Custom Styles -->
    <link rel="stylesheet" href="main.css">

    <style>


    </style>

    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <!-- Bootstrap JS and dependencies -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <!-- DOMPurify for sanitizing user input -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js" integrity="sha512-..."
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Firebase SDK (v9 Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, push, onValue, update, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "elpitiyadivision-701e8.firebaseapp.com",
            databaseURL: "https://elpitiyadivision-701e8-default-rtdb.firebaseio.com",
            projectId: "elpitiyadivision-701e8",
            storageBucket: "elpitiyadivision-701e8.appspot.com",
            messagingSenderId: "845789496115",
            appId: "1:845789496115:web:4dbc0d8263533543947446"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        $(document).ready(function () {
            const listFormRef = ref(db, 'list_form/');

            // Function to sanitize and escape user input
            function sanitizeInput(input) {
                return DOMPurify.sanitize(input);
            }

            // Displaying vehicles
            onValue(listFormRef, (snapshot) => {
                const tbodyEl = $('tbody');
                tbodyEl.empty(); // Clear table body
                let count = 0;
                snapshot.forEach((product) => {
                    count += 1;
                    const vehicle = product.val();
                    const sanitizedTitle = sanitizeInput(vehicle.dataTitle);
                    const sanitizedLang = sanitizeInput(vehicle.dataLang);
                    const sanitizedDesc = sanitizeInput(vehicle.dataDesc);

                    const itemStr = [...Object.values(vehicle), count].join(' ');
                    // console.log(itemStr);
                    tbodyEl.append(`
                        <tr data-item="${itemStr}" >
                          <td>${count}</td>
                          <td><input type="text" class="form-control" id="${vehicle.id}_title" value="${sanitizedTitle}" readonly></td>
                          <td><input type="text" class="form-control" id="${vehicle.id}_lang" value="${sanitizedLang}" readonly></td>
                          <td><input type="text" class="form-control" id="${vehicle.id}_desc" value="${sanitizedDesc}" readonly></td>
                          <td>
                            <button class="btn btn-warning edit" data-id="${vehicle.id}"><i class="bi bi-pencil-square"></i> Edit</button>
                            <button class="btn btn-danger delete" data-id="${vehicle.id}"><i class="bi bi-trash me-1"></i> Delete</button>
                          </td>
                        </tr>
                    `);
                });[]
            });

            // Adding a new vehicle
            $('#form').submit(function (e) {
                e.preventDefault();

                const dataDesc = $('#dataDesc').val().trim();
                const dataLang = $('#dataLang').val().trim();
                const dataTitle = $('#dataTitle').val().trim();

                if (!dataDesc || !dataLang || !dataTitle) {
                    alert('All fields are required!');
                    return;
                }

                addVehicle(dataDesc, dataLang, dataTitle);
                $('#form')[0].reset();  // Reset the form
            });

            function addVehicle(dataDesc, dataLang, dataTitle) {
                const newPostRef = push(ref(db, 'list_form'));
                const user = {
                    id: newPostRef.key,
                    created_at: serverTimestamp(),
                    dataDesc: dataDesc,
                    dataLang: dataLang,
                    dataTitle: dataTitle,
                };
                update(newPostRef, user)
                    .then(() => {
                        alert('Vehicle added successfully!');
                    })
                    .catch((error) => {
                        console.error('Error adding vehicle:', error);
                        alert('Failed to add vehicle.');
                    });
            }

            // Editing vehicle using modal
            $('table').on('click', '.edit', function () {
                const id = $(this).data('id');
                const title = $(`#${id}_title`).val();
                const lang = $(`#${id}_lang`).val();
                const desc = $(`#${id}_desc`).val();

                $('#editId').val(id);
                $('#editTitle').val(title);
                $('#editLang').val(lang);
                $('#editDesc').val(desc);

                $('#editModal').modal('show');
            });

            // Updating vehicle
            $('#editForm').submit(function (e) {
                e.preventDefault();

                const id = $('#editId').val();
                const dataDesc = $('#editDesc').val().trim();
                const dataLang = $('#editLang').val().trim();
                const dataTitle = $('#editTitle').val().trim();

                if (!dataDesc || !dataLang || !dataTitle) {
                    alert('All fields are required!');
                    return;
                }

                updateVehicle(id, dataDesc, dataLang, dataTitle);
                $('#editModal').modal('hide');
            });

            function updateVehicle(id, dataDesc, dataLang, dataTitle) {
                const updates = {
                    dataDesc: dataDesc,
                    dataLang: dataLang,
                    dataTitle: dataTitle,
                };
                update(ref(db, `list_form/${id}`), updates)
                    .then(() => {
                        alert('Vehicle updated successfully!');
                    })
                    .catch((error) => {
                        console.error('Error updating vehicle:', error);
                        alert('Failed to update vehicle.');
                    });
            }

            // Deleting vehicle using modal
            let deleteVehicleId = null; // To store the ID of the vehicle to delete

            $('table').on('click', '.delete', function () {
                const id = $(this).data('id');
                const title = $(`#${id}_title`).val();
                const lang = $(`#${id}_lang`).val();
                const desc = $(`#${id}_desc`).val();

                deleteVehicleId = id; // Store the ID for deletion

                // Populate the modal with vehicle details for confirmation
                $('#deleteVehicleTitle').text(title);
                $('#deleteVehicleLang').text(lang);
                $('#deleteVehicleDesc').text(desc);

                $('#deleteModal').modal('show');
            });

            // Confirm deletion
            $('#confirmDeleteBtn').click(function () {
                if (deleteVehicleId) {
                    remove(ref(db, `list_form/${deleteVehicleId}`))
                        .then(() => {
                            alert('Vehicle deleted successfully!');
                            $('#deleteModal').modal('hide');
                        })
                        .catch((error) => {
                            console.error('Error deleting vehicle:', error);
                            alert('Failed to delete vehicle.');
                            $('#deleteModal').modal('hide');
                        });
                }
            });

            // Search Functionality
            $("#searchInput").on("keyup", function () {
                const value = $(this).val().toLowerCase();
                $("table tbody tr").filter(function () {
                    // Check if the text of the row includes the search value
                    const rowText = $(this).data('item').toLowerCase() // .text().toLowerCase();
                    // console.log('rowtext', rowText);
                    $(this).toggle(rowText.indexOf(value) > -1);
                });
            });

        });

    </script>
</head>

<body>
    <div class="container">

        <!-- Header Section -->
        <div class="row" id="header">
            <div class="colum">
                <img src="image/logo.jpg" alt="logo">
            </div>
            <div class="colum">
                <h1 class="h1">Elpitiya Divitions</h1>
                <br>
                <h2 class="h2">Vehicle Management System</h2>
            </div>
            <div class="colum">
                <a href="index.html">
                    <button>
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </a>
            </div>
        </div>

        <!-- Add Vehicle Form -->
        <div class="row" id="formdiv">
            <h2>Add New Wanted Vehicle</h2>
            <form id="form" class="form-inline">
                <div class="form-group mx-sm-3 mb-2">
                    <label for="dataTitle">වාහන අංකය :</label>
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fas fa-car"></i></span>
                        </div>
                        <input type="text" class="form-control" id="dataTitle" placeholder="වාහන අංකය :-" required>
                    </div>
                </div>

                <div class="form-group mx-sm-3 mb-2">
                    <label for="dataLang">නැති වූ දිනය :</label>
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                        </div>
                        <input type="text" class="form-control" id="dataLang" placeholder="නැති වූ දිනය :-" required>
                    </div>
                </div>

                <div class="form-group mx-sm-3 mb-2">
                    <label for="dataDesc">පොලිස් ස්ථානය :</label>
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fas fa-building"></i></span>
                        </div>
                        <input type="text" class="form-control" id="dataDesc" name="todo" placeholder="පොලිස් ස්ථානය :-"
                            required>
                    </div>
                </div>
                <button type="submit" name="Add" id="add" value="add" class="btn btn-primary">
                    <i class="fas fa-car"></i> ADD VEHICLE
                </button>
            </form>
        </div>

        <!-- Search Bar -->
        <div class="row" id="search">
            <h2>Search Vehicle</h2>
            <div class="col-md-12 text-center">
                <input type="text" id="searchInput" class="form-control" placeholder="Search Vehicle...">
            </div>
        </div>

        <!-- Vehicle Table -->
        <div class="row" id="table">
            <h2>Wanted Vehicles</h2>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>අනු අංක</th>
                        <th>වාහන අංකය</th>
                        <th>නැති වූ දිනය</th>
                        <th>පොලිස් ස්ථානය</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Vehicle records will be inserted here by JavaScript -->
                </tbody>
            </table>
        </div>

    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form id="editForm">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editModalLabel"><i class="bi bi-pencil-square mr-2"></i> Edit
                            Vehicle</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="editId">
                        <div class="form-group">
                            <label for="editTitle">වාහන අංකය</label>
                            <input type="text" class="form-control" id="editTitle" required>
                        </div>
                        <div class="form-group">
                            <label for="editLang">නැති වූ දිනය</label>
                            <input type="text" class="form-control" id="editLang" required>
                        </div>
                        <div class="form-group">
                            <label for="editDesc">පොලිස් ස්ථානය</label>
                            <input type="text" class="form-control" id="editDesc" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">
                            <i class="bi bi-x-circle mr-2"></i> Close
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle mr-2"></i> Update Vehicle
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel"><i class="bi bi-trash-fill mr-2"></i> Delete Vehicle
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <i class="bi bi-x-circle"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete the following vehicle?</p>
                    <ul>
                        <li><strong>වාහන අංකය:</strong> <span id="deleteVehicleTitle"></span></li>
                        <li><strong>නැති වූ දිනය:</strong> <span id="deleteVehicleLang"></span></li>
                        <li><strong>පොලිස් ස්ථානය:</strong> <span id="deleteVehicleDesc"></span></li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="bi bi-x-circle mr-2"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                        <i class="bi bi-trash-fill mr-2"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

</body>

</html>
